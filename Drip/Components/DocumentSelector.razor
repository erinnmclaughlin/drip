@inject OpenApiStateService StateService

@if (IsExpanded)
{
    <HeadlessBlazor.HBOutsideClickBehavior Container="_dropdownRef" OnClick="ToggleDropdown" />
}

<div class="document-selector @(IsExpanded ? "expanded" : "")" @ref="_dropdownRef">
    <button type="button" class="document-selector-toggle" @onclick="ToggleDropdown" title="Switch between documents">
        <span class="document-selector-icon">
            @AppIcon.File()
        </span>
        <span class="document-selector-text">
            @if (CurrentDocument != null)
            {
                @CurrentDocument.Name
            }
            else
            {
                <span>No Document</span>
            }
        </span>
        <span class="document-selector-arrow">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6,9 12,15 18,9"></polyline>
            </svg>
        </span>
    </button>
    
    @if (IsExpanded)
    {
        <div class="document-selector-content">
            <div class="document-selector-header">
                <span class="document-selector-title">Documents</span>
                <span class="document-count">@StateService.AllDocuments.Count()</span>
            </div>
            
            <div class="document-list">
                @foreach (var document in StateService.AllDocuments)
                {
                    <button type="button" 
                            class="document-item @(document.Id == StateService.CurrentDocumentId ? "active" : "")" 
                            @onclick="() => SelectDocument(document.Id)">
                        <span class="item-dot@(document.Id == StateService.CurrentDocumentId ? " active" : "")"></span>
                        <div class="document-item-info">
                            <span class="document-name">@document.Name</span>
                            <span class="document-source">@GetSourceLabel(document.Source)</span>
                        </div>
                        <div class="document-item-icons">
                            @if (document.Source != "default")
                            {
                                <button type="button" 
                                        class="document-remove-btn" 
                                        @onclick:stopPropagation="true"
                                        @onclick="() => RemoveDocument(document.Id)"
                                        title="Remove document">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            }
                        </div>
                    </button>
                }
            </div>
            
            @if (!StateService.AllDocuments.Any())
            {
                <div class="document-empty">
                    <span>No documents available</span>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool IsExpanded { get; set; }
    private DocumentInfo? CurrentDocument => StateService.GetCurrentDocumentInfo();
    private ElementReference _dropdownRef;
    
    private void ToggleDropdown()
    {
        IsExpanded = !IsExpanded;
    }
    
    private void SelectDocument(string documentId)
    {
        StateService.SwitchToDocument(documentId);
        IsExpanded = false;
    }
    
    private void RemoveDocument(string documentId)
    {
        StateService.RemoveDocument(documentId);
    }
    
    private static string GetSourceLabel(string source) => source switch
    {
        "default" => "Default",
        "uploaded" => "Uploaded",
        _ => source
    };
} 