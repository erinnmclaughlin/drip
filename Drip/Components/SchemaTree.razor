@using Microsoft.OpenApi.Models

<div class="schema-tree">
    @if (Schema?.Type == "object" && Schema.Properties?.Any() == true)
    {
        @foreach (var (propertyName, propertySchema) in Schema.Properties)
        {
            var isRequired = Schema.Required?.Contains(propertyName) == true;
            <div class="schema-property">
                <div class="property-header">
                    <span class="property-name">
                        @propertyName
                        @if (isRequired)
                        {
                            <span class="required-indicator">*</span>
                        }
                    </span>
                    <span class="property-type">@GetTypeDisplay(propertySchema)</span>
                </div>
                @if (!string.IsNullOrEmpty(propertySchema.Description))
                {
                    <div class="property-description">@propertySchema.Description</div>
                }
                @if (propertySchema.Type == "object" && propertySchema.Properties?.Any() == true)
                {
                    <div class="property-nested schema-nested">
                        <SchemaTree Schema="propertySchema" NestingLevel="NestingLevel + 1" />
                    </div>
                }
                else if (propertySchema.Type == "array")
                {
                    <div class="property-nested schema-nested">
                        <div class="array-items-label">Items:</div>
                        <div class="array-items-content">
                            <SchemaTree Schema="propertySchema.Items" NestingLevel="NestingLevel + 1" />
                        </div>
                    </div>
                }
                else if (propertySchema.Reference != null)
                {
                    <div class="property-nested schema-nested">
                        <SchemaTree Schema="Document.Components.Schemas[propertySchema.Reference.Id]" NestingLevel="NestingLevel + 1" />
                    </div>
                }
            </div>
        }
    }
    else if (Schema?.Type == "array")
    {
        <div class="schema-array">
            <div class="schema-header" @onclick="ToggleExpanded">
                <span class="schema-type">array</span>
                @if (!string.IsNullOrEmpty(Schema.Title))
                {
                    <span class="schema-title">@Schema.Title</span>
                }
                <span class="schema-toggle">@(IsExpanded ? "▼" : "▶")</span>
            </div>
            @if (IsExpanded)
            {
                <div class="schema-content">
                    @if (!string.IsNullOrEmpty(Schema.Description))
                    {
                        <div class="schema-description">@Schema.Description</div>
                    }
                    @if (Schema.Items != null)
                    {
                        <div class="array-items">
                            <div class="array-items-label">Items:</div>
                            <div class="array-items-content">
                                <SchemaTree Schema="Schema.Items" NestingLevel="NestingLevel + 1" />
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    else if (Schema?.Reference != null && Document?.Components?.Schemas?.ContainsKey(Schema.Reference.Id) == true)
    {
        <div class="schema-reference">
            <div class="schema-header" @onclick="ToggleExpanded">
                <span class="schema-type">reference</span>
                <span class="reference-name">@Schema.Reference.Id</span>
                <span class="schema-toggle">@(IsExpanded ? "▼" : "▶")</span>
            </div>
            @if (IsExpanded)
            {
                <div class="schema-content">
                    <SchemaTree Schema="Document.Components.Schemas[Schema.Reference.Id]" NestingLevel="NestingLevel + 1" />
                </div>
            }
        </div>
    }
    else if (Schema != null)
    {
        <div class="schema-primitive">
            <span class="schema-type">@GetTypeDisplay(Schema)</span>
            @if (!string.IsNullOrEmpty(Schema.Description))
            {
                <span class="schema-description">@Schema.Description</span>
            }
            @if (Schema.Format != null)
            {
                <span class="schema-format">(@Schema.Format)</span>
            }
            @if (Schema.Enum?.Any() == true)
            {
                <div class="schema-enum">
                    <span class="enum-label">Values:</span>
                    <span class="enum-values">@string.Join(", ", Schema.Enum.Select(e => e.ToString()))</span>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public required OpenApiSchema Schema { get; set; }

    [CascadingParameter]
    public required OpenApiDocument Document { get; set; }

    [Parameter]
    public int NestingLevel { get; set; } = 0;

    private bool IsExpanded { get; set; } = true;

    private void ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
    }

    private string GetTypeDisplay(OpenApiSchema? schema)
    {
        if (schema == null) return "unknown";
        if (schema.Reference != null)
        {
            return $"ref: {schema.Reference.Id}";
        }
        if (schema.Type == "array")
        {
            var itemType = GetTypeDisplay(schema.Items);
            return $"{itemType}[]";
        }
        if (schema.Type == "object")
        {
            return null; // Don't show 'object' label
        }
        var type = schema.Type ?? "unknown";
        if (!string.IsNullOrEmpty(schema.Format))
        {
            return $"{type} ({schema.Format})";
        }
        return type;
    }
}
